<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>BASTION</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--b:#06060c;--p:#0c0c18;--p2:#10101f;--bd:#1c1c30;--a:#00ffd0;--r:#ff3355;--g:#ffc830;--f:'JetBrains Mono',monospace;--h:'Orbitron',sans-serif}
html,body{height:100%;overflow:hidden}
body{background:var(--b);color:#ccc;font-family:var(--f);display:flex;flex-direction:column;user-select:none;font-size:12px}
button{font-family:var(--f);cursor:pointer}
/* Setup */
#S{position:fixed;inset:0;z-index:300;display:flex;align-items:center;justify-content:center;background:var(--b);overflow-y:auto}
#S.off{display:none}
.SU{text-align:center;max-width:580px;width:95%;padding:20px 0}
.SU h1{font-family:var(--h);font-size:36px;font-weight:900;letter-spacing:10px;color:var(--a);text-shadow:0 0 30px #00ffd033;margin-bottom:4px}
.SU>p{color:#444;font-size:12px;margin-bottom:18px;letter-spacing:3px}
.SL{font-family:var(--h);font-size:10px;font-weight:700;color:#444;letter-spacing:3px;margin-bottom:8px}
.SR{display:flex;gap:7px;justify-content:center;margin-bottom:14px;flex-wrap:wrap}
.MC,.DC{padding:9px 12px;background:var(--p);border:2px solid var(--bd);border-radius:8px;cursor:pointer;transition:all .12s}
.MC:hover,.DC:hover{border-color:#444}
.MC.on,.DC.on{border-color:var(--a);box-shadow:0 0 10px #00ffd044}
.MC{width:125px}.MC canvas{display:block;margin:0 auto 5px;border-radius:3px}
.MC b,.DC b{font-family:var(--h);font-size:9px;display:block;letter-spacing:1px;color:#ccc;margin-bottom:1px}
.MC i,.DC i{font-style:normal;font-size:8px;color:#555;display:block}
.DB{background:var(--a);color:#000;border:none;border-radius:7px;padding:12px 36px;font-family:var(--h);font-weight:900;font-size:13px;letter-spacing:4px;margin:4px;transition:all .12s}
.DB:hover{box-shadow:0 0 20px #00ffd055;transform:scale(1.02)}
.DB.alt{background:#333;color:#aaa}.DB.alt:hover{background:#444;color:#fff;box-shadow:none}
.SKB{background:var(--p);border:1px solid var(--g);border-radius:7px;padding:9px 18px;font-family:var(--h);font-size:10px;color:var(--g);letter-spacing:2px;margin-top:12px}
.SKB:hover{background:#1a1a10;box-shadow:0 0 10px #ffc83033}
/* Skill Modal */
#SK{display:none;position:fixed;inset:0;z-index:400;align-items:center;justify-content:center;background:#000d}
#SK.show{display:flex}
.SKX{background:var(--p);border:1px solid var(--g);border-radius:10px;padding:20px;width:92%;max-width:520px;max-height:82vh;overflow-y:auto;position:relative}
.SKX h2{font-family:var(--h);font-size:16px;color:var(--g);letter-spacing:4px;text-align:center;margin-bottom:3px}
.SKC{text-align:center;font-family:var(--h);font-size:13px;color:var(--g);margin-bottom:12px}
.SKG{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.SKI{background:var(--p2);border:1px solid var(--bd);border-radius:6px;padding:8px;cursor:pointer;transition:all .1s}
.SKI:hover{border-color:#444}.SKI.mx{opacity:.45;cursor:default}
.SKI b{font-family:var(--h);font-size:9px;display:block;color:#ccc;letter-spacing:1px;margin-bottom:2px}
.SKI i{font-style:normal;font-size:8px;color:#555;display:block;margin-bottom:3px}
.SKI em{font-style:normal;font-size:9px;color:var(--g)}
.SKXB{position:absolute;top:8px;right:12px;background:none;border:none;color:#555;font-size:15px}
.SKXB:hover{color:var(--r)}
.SKRB{display:block;margin:10px auto 0;background:#1a0a0a;border:1px solid #331818;border-radius:4px;padding:5px 14px;color:#ff7777;font-size:9px}
.SKRB:hover{background:#2a1010}
/* Header */
#H{display:flex;align-items:center;justify-content:space-between;padding:4px 14px;background:var(--p);border-bottom:1px solid var(--bd)}
#H h1{font-family:var(--h);font-weight:900;font-size:15px;letter-spacing:4px;color:var(--a)}
.ST{display:flex;gap:14px}.ST>div{text-align:center}
.ST small{font-size:7px;color:#444;text-transform:uppercase;letter-spacing:2px;font-family:var(--h);display:block}
.ST span{font-family:var(--h);font-weight:700;font-size:14px}
/* Controls */
#C{display:flex;align-items:center;gap:4px;padding:3px 14px;background:var(--p2);border-bottom:1px solid var(--bd);flex-wrap:wrap}
.B{background:var(--p);border:1px solid var(--bd);border-radius:4px;padding:4px 10px;font-family:var(--h);font-size:8px;font-weight:700;letter-spacing:1px;color:#666;transition:all .1s}
.B:hover{border-color:var(--a);color:var(--a)}
.B.on{border-color:var(--a);color:#000;background:var(--a)}
.B.pri{background:var(--a);color:#000;border-color:var(--a);font-size:9px;padding:5px 13px}
.B:disabled{opacity:.3;cursor:not-allowed}
.CSP{flex:1}
.WA{font-family:var(--h);font-size:8px;letter-spacing:1px;padding:0 5px}
.WA.bo{color:#ff6633}.WA.nw{color:var(--g)}.WA.hd{color:transparent}
.WP{font-size:8px;color:#444;padding:0 4px}
/* Game Layout */
#G{display:flex;flex:1;overflow:hidden}
#L{display:flex;flex-direction:column;flex:1;min-width:0}
#CW{position:relative;flex:1;display:flex;align-items:center;justify-content:center;background:#040409;overflow:hidden}
canvas{display:block}
/* Upgrade Popup */
#U{display:none;position:absolute;background:#0a0a16ee;border:1px solid var(--a);border-radius:7px;padding:9px 10px;font-size:11px;z-index:10;width:235px;box-shadow:0 4px 18px #000a,0 0 14px #00ffd018;backdrop-filter:blur(5px);max-height:90%;overflow-y:auto}
#U.show{display:block}
.UH{display:flex;justify-content:space-between;margin-bottom:3px}
.UN{font-family:var(--h);font-size:11px;font-weight:700}
.UX{background:none;border:none;color:#444;font-size:13px}.UX:hover{color:var(--r)}
.UR{display:flex;justify-content:space-between;color:#666;font-size:10px;line-height:1.7}.UR b{color:#aaa;font-weight:400}
.UD{border:none;border-top:1px solid #1a1a2e;margin:4px 0}
.TR{display:flex;align-items:center;gap:3px;margin-bottom:4px;flex-wrap:wrap}
.TL{font-size:8px;color:#555;font-family:var(--h);flex-shrink:0}
.TB{padding:2px 5px;font-size:8px;font-family:var(--h);font-weight:700;border:1px solid var(--bd);border-radius:3px;color:#555;background:var(--p);transition:all .1s}
.TB:hover{border-color:#444;color:#888}
.TB.on{border-color:var(--a);color:var(--a);background:#0a1a18}
.UB{background:#141430;border:1px solid #252540;border-radius:4px;padding:5px 7px;color:#ccc;width:100%;font-size:10px;transition:all .1s;margin-bottom:2px;display:flex;justify-content:space-between}
.UB:hover{border-color:var(--a);background:#1a1a3a}
.UB.no{opacity:.3;cursor:not-allowed}.UB.no:hover{border-color:#252540;background:#141430}
.US{background:#1a0a0a;border:1px solid #2a1515;border-radius:4px;padding:4px;color:#ff7777;width:100%;font-size:10px;text-align:center;margin-top:3px}
.US:hover{border-color:#ff4444;background:#2a1010}
/* Bestiary */
#BB{background:var(--p);border-top:1px solid var(--bd);padding:4px 8px;flex-shrink:0}
.BT{font-family:var(--h);font-size:7px;color:#333;letter-spacing:3px;margin-bottom:3px}
#BL{display:flex;gap:4px;overflow-x:auto;padding-bottom:2px}
#BL::-webkit-scrollbar{height:3px}#BL::-webkit-scrollbar-thumb{background:#1a1a2e;border-radius:2px}
.BE{min-width:145px;max-width:145px;flex-shrink:0;padding:5px;border:1px solid var(--bd);border-radius:4px;background:#08080f;font-size:7px}
.BE.hd{opacity:.14}
.BH{display:flex;align-items:center;gap:5px;margin-bottom:2px}
.BO{width:18px;height:18px;border-radius:50%;flex-shrink:0}
.BN{font-family:var(--h);font-size:7px;font-weight:700;letter-spacing:1px}
.BD{font-size:6px;color:#444}
.BG{display:grid;grid-template-columns:1fr 1fr;gap:1px 4px;font-size:6px;margin:2px 0}
.BG .k{color:#2a2a3a}.BG .v{color:#888}
.BK{font-size:6px;color:#444;margin-top:2px;padding-top:2px;border-top:1px solid #0e0e1a}
.BK strong{color:var(--a)}
/* Sidebar */
#R{width:178px;background:var(--p);border-left:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0}
.RH{font-family:var(--h);font-size:8px;color:#333;letter-spacing:2px;padding:5px 7px 2px}
#TL{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#1a1a2e transparent}
#TL::-webkit-scrollbar{width:3px}#TL::-webkit-scrollbar-thumb{background:#1a1a2e;border-radius:2px}
.TW{margin:0 4px 2px;padding:4px 6px;background:var(--p2);border:1px solid var(--bd);border-radius:4px;cursor:pointer;transition:all .1s;position:relative}
.TW:hover{border-color:#2a2a44}
.TW.sel{border-color:var(--a);box-shadow:0 0 6px #00ffd018}
.TW.brk{opacity:.4}
.TW.lk{cursor:default}.TW.lk:hover{border-color:var(--bd)}
.TW.lk .TI{opacity:.14;filter:grayscale(1)}
.TW .LB{display:none;position:absolute;inset:0;border-radius:3px;background:#06060ccc;align-items:center;justify-content:center;font-family:var(--h);font-size:6px;color:#444}
.TW.lk .LB{display:flex}
.TI{display:flex;align-items:center;gap:5px}
.TC{width:17px;height:17px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;flex-shrink:0}
.TN{font-family:var(--h);font-size:7px;font-weight:700;letter-spacing:1px}
.TD2{font-size:6px;color:#444}
.TP{font-size:8px;color:var(--g);font-weight:700}
.DT{margin:0 4px;padding:4px 5px;background:var(--p2);border:1px solid var(--bd);border-radius:4px;font-size:7px}
.DT label{font-family:var(--h);font-size:6px;color:#333;letter-spacing:1px;display:block;margin-bottom:2px}
.DT .DO{display:flex;gap:2px;flex-wrap:wrap}
.DT .DO div{padding:1px 4px;font-size:6px;font-family:var(--h);font-weight:700;border:1px solid var(--bd);border-radius:2px;color:#555;background:var(--p);cursor:pointer}
.DT .DO div.on{border-color:var(--a);color:var(--a);background:#0a1a18}
.RI{font-size:6px;color:#1a1a2e;text-align:center;padding:3px;margin-top:auto}
/* Resize */
#RZ{width:5px;background:var(--bd);cursor:col-resize;flex-shrink:0}
#RZ:hover{background:var(--a)}
/* Overlay */
.OV{display:none;position:fixed;inset:0;z-index:200;align-items:center;justify-content:center}.OV.show{display:flex}
.OV .bg{position:absolute;inset:0;background:#000c}
.OV .bx{position:relative;z-index:1;text-align:center;background:var(--p);border:1px solid var(--bd);border-radius:10px;padding:28px 40px}
.OV .bx h2{font-family:var(--h);font-size:26px;font-weight:900;letter-spacing:5px;color:var(--r);margin-bottom:6px}
.OV .bx p{color:#555;font-size:12px;margin:3px 0}
.OV .bx button{border:none;border-radius:5px;padding:9px 22px;font-family:var(--h);font-weight:700;font-size:10px;letter-spacing:2px;margin:8px 3px 0;background:var(--r);color:#fff}
/* Settings Modal */
#SET{display:none;position:fixed;inset:0;z-index:400;align-items:center;justify-content:center;background:#000d}
#SET.show{display:flex}
.SET-bx{background:var(--p);border:1px solid var(--a);border-radius:10px;padding:20px;width:90%;max-width:400px;position:relative}
.SET-bx h2{font-family:var(--h);font-size:16px;color:var(--a);letter-spacing:4px;text-align:center;margin-bottom:12px}
.SET-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #1a1a2e;font-size:11px}
.SET-row label{color:#888}
.SET-row select,.SET-row input[type=checkbox]{font-family:var(--f);background:var(--p2);color:#ccc;border:1px solid var(--bd);border-radius:4px;padding:3px 6px;font-size:10px}
.SET-row input[type=checkbox]{width:16px;height:16px;accent-color:var(--a)}
.SET-x{position:absolute;top:8px;right:12px;background:none;border:none;color:#555;font-size:15px;cursor:pointer}
.SET-x:hover{color:var(--r)}
/* Confirm dialog */
#confirm{display:none;position:absolute;background:#0c0c1aee;border:1px solid var(--r);border-radius:6px;padding:10px;z-index:20;text-align:center;font-size:11px;min-width:160px;backdrop-filter:blur(5px)}
#confirm.show{display:block}
#confirm p{margin-bottom:8px;color:#ccc}
#confirm button{padding:4px 12px;border:none;border-radius:4px;font-family:var(--h);font-size:8px;font-weight:700;letter-spacing:1px;cursor:pointer;margin:0 3px}
#confirm .cy{background:var(--r);color:#fff}
#confirm .cn{background:var(--bd);color:#888}
.CE{color:var(--g);font-family:var(--h);font-size:12px;margin-top:6px}
</style></head><body>
<div id="S"><div class="SU"><h1>BASTION</h1><p>TOWER DEFENSE</p>
<div class="SL">MAP</div><div class="SR" id="MR"></div>
<div class="SL">DIFFICULTY</div><div class="SR" id="DR"></div>
<button class="DB" id="go">Deploy</button><button class="DB alt" id="sb">Sandbox</button>
<br><button class="SKB" id="sko">‚¨° Skill Tree</button><button class="SKB" id="seto" style="border-color:var(--a);color:var(--a)">‚öô Settings</button></div></div>
<!-- Settings -->
<div id="SET"><div class="SET-bx"><button class="SET-x" id="setx">‚úï</button><h2>SETTINGS</h2>
<div class="SET-row"><label>Default Difficulty</label><select id="s-diff"></select></div>
<div class="SET-row"><label>Confirm before selling</label><input type="checkbox" id="s-confirm" checked></div>
<div class="SET-row"><label>Default Speed</label><select id="s-speed"><option value="1">1√ó</option><option value="2">2√ó</option><option value="3">3√ó</option></select></div>
<div class="SET-row"><label>Auto-start waves</label><input type="checkbox" id="s-auto"></div>
</div></div>
<div id="SK"><div class="SKX"><button class="SKXB" id="skx">‚úï</button><h2>SKILL TREE</h2><div class="SKC" id="skc"></div><div class="SKG" id="skg"></div><button class="SKRB" id="skr">Reset (Refund)</button></div></div>
<div id="H"><h1>BASTION</h1><div class="ST"><div><small>Gold</small><span style="color:var(--g)" id="vg">0</span></div><div><small>Lives</small><span style="color:var(--r)" id="vl">0</span></div><div><small>Wave</small><span style="color:var(--a)" id="vw">0</span></div><div><small>Score</small><span id="vs">0</span></div></div></div>
<div id="C"><button class="B pri" id="wb">Wave 1</button><button class="B" id="ab">Auto</button><button class="B" id="pb">‚è∏</button><button class="B" id="xb">1√ó</button><div class="WA hd" id="wa">&nbsp;</div><div class="WP" id="wp"></div><div class="CSP"></div><button class="B" id="nb">‚öô Menu</button></div>
<div id="G"><div id="L"><div id="CW"><canvas id="cv"></canvas><div id="U"><div class="UH"><div class="UN" id="un"></div><button class="UX" id="ux">‚úï</button></div><div id="ub"></div></div><div id="confirm"><p>Sell this tower?</p><button class="cy" id="cf-y">Sell</button><button class="cn" id="cf-n">Cancel</button></div></div><div id="BB"><div class="BT">BESTIARY</div><div id="BL"></div></div></div><div id="RZ"></div><div id="R"><div class="RH">TOWERS</div><div id="TL"></div><div class="DT"><label>DEFAULT TARGET</label><div class="DO" id="do"></div></div><div class="RI">1-9,0 towers ¬∑ Space wave ¬∑ P pause ¬∑ S speed</div></div></div>
<div id="GO" class="OV"><div class="bg"></div><div class="bx"><h2>DEFEATED</h2><p id="gt"></p><div class="CE" id="gc"></div><button id="gb">Menu</button></div></div>
<script>
const Q=id=>document.getElementById(id),P=Math.PI*2,T=40,NC=20,NR=14;
const cv=Q('cv'),cx=cv.getContext('2d');cv.width=800;cv.height=560;
// ‚ïê‚ïê‚ïê TARGETING ‚ïê‚ïê‚ïê
const TGS=['first','last','strong','weak','fast','close'],
TGL={first:'First',last:'Last',strong:'Strong',weak:'Weak',fast:'Fast',close:'Close'},
TGI={first:'F',last:'L',strong:'S',weak:'W',fast:'‚ö°',close:'C'};
// ‚ïê‚ïê‚ïê SKILLS (localStorage) ‚ïê‚ïê‚ïê
const SKD=[
{id:'gold',nm:'Mint',ds:'+15 start gold/lv',mx:5,cs:[3,5,8,12,18],fn:l=>l*15},
{id:'lives',nm:'Fortify',ds:'+3 start lives/lv',mx:5,cs:[3,5,8,12,18],fn:l=>l*3},
{id:'dmg',nm:'Arsenal',ds:'+5% tower dmg/lv',mx:5,cs:[4,7,11,16,22],fn:l=>1+l*.05},
{id:'rng',nm:'Optics',ds:'+4% range/lv',mx:5,cs:[4,7,11,16,22],fn:l=>1+l*.04},
{id:'sell',nm:'Salvage',ds:'+5% sell value/lv',mx:5,cs:[3,5,8,12,18],fn:l=>.6+l*.05},
{id:'inc',nm:'Bounty',ds:'+8% kill gold/lv',mx:5,cs:[5,8,12,18,25],fn:l=>1+l*.08},
{id:'crit',nm:'Precision',ds:'+3% crit(2√ó)/lv',mx:5,cs:[6,10,15,22,30],fn:l=>l*.03},
{id:'spd',nm:'Overclock',ds:'+3% atk speed/lv',mx:5,cs:[5,8,12,18,25],fn:l=>1-l*.03}
];
let cores=0,skLv={};
function skLoad(){try{const d=JSON.parse(localStorage.getItem('bastion'));if(d){cores=d.c||0;skLv=d.l||{}}}catch(e){}SKD.forEach(s=>{if(!skLv[s.id])skLv[s.id]=0})}
function skSave(){try{localStorage.setItem('bastion',JSON.stringify({c:cores,l:skLv}))}catch(e){}}
function skE(id){const s=SKD.find(x=>x.id===id);return s?s.fn(skLv[s.id]):1}
function skRender(){Q('skc').textContent='‚¨° '+cores+' Cores';const g=Q('skg');g.innerHTML='';SKD.forEach(s=>{const l=skLv[s.id],m=l>=s.mx,d=document.createElement('div');d.className='SKI'+(m?' mx':'');d.innerHTML=`<b>${s.nm}</b><i>${s.ds}</i><em>Lv${l}/${s.mx} ${m?'MAX':'¬∑ ‚¨°'+s.cs[l]}</em>`;if(!m)d.onclick=()=>{if(cores>=s.cs[l]){cores-=s.cs[l];skLv[s.id]++;skSave();skRender()}};g.appendChild(d)})}
skLoad();
Q('sko').onclick=()=>{Q('SK').classList.add('show');skRender()};
Q('skx').onclick=()=>Q('SK').classList.remove('show');
Q('skr').onclick=()=>{let r=0;SKD.forEach(s=>{for(let i=0;i<skLv[s.id];i++)r+=s.cs[i];skLv[s.id]=0});cores+=r;skSave();skRender()};
// ‚ïê‚ïê‚ïê DATA ‚ïê‚ïê‚ïê
const MAPS=[
{n:'Serpent',d:'Winding path',g:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[2,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0],[0,0,0,0,1,1,1,1,1,1,0,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},
{n:'Spiral',d:'Tight coil',g:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,0,0],[0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0],[0,0,1,0,0,1,1,1,1,1,1,1,0,0,1,0,0,1,0,0],[0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,1,0,0],[0,0,1,0,0,1,0,0,3,0,0,1,0,0,1,0,0,1,0,0],[0,0,1,0,0,1,1,1,1,1,1,1,0,0,1,0,0,1,0,0],[0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},
{n:'Gauntlet',d:'Open field',g:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[2,1,1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,1,3],[0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,1,1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,1,0],[0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0]]}];
const DIFFS=[{n:'Easy',g:300,l:60,h:.85,r:1.1},{n:'Normal',g:200,l:40,h:1,r:1},{n:'Hard',g:130,l:25,h:1.25,r:.8},{n:'Brutal',g:90,l:15,h:1.6,r:.6}];
// 15 Towers: $=cost R=range A=rate(ms) D=dmg C=color Y=symbol N=name X=desc U=unlock wave
const TK='gun can fro min sni poi las tes mor vor pul rai fla cry pla ann'.split(' ');
const TD={
gun:{$:40,R:100,A:400,D:8,C:'#00ffd0',S:0,Y:'‚äï',N:'Gun',X:'Fast single',U:0},
can:{$:90,R:120,A:1400,D:28,C:'#ff8844',S:50,Y:'‚ú¶',N:'Cannon',X:'Splash',U:0},
fro:{$:65,R:100,A:700,D:3,C:'#44aaff',S:0,Y:'‚ùÑ',N:'Frost',X:'Slows',U:0,sl:1},
min:{$:100,R:0,A:0,D:0,C:'#ffcc00',S:0,Y:'‚¨°',N:'GoldMine',X:'Earns gold/wave',U:0,inc:1,incAmt:25},
sni:{$:120,R:200,A:2000,D:65,C:'#cc66ff',S:0,Y:'‚óé',N:'Sniper',X:'Long range',U:3},
poi:{$:85,R:90,A:1200,D:4,C:'#88cc00',S:60,Y:'‚ò£',N:'Poison',X:'DOT area',U:5,dt:1},
las:{$:140,R:110,A:80,D:1.5,C:'#ff3366',S:0,Y:'‚ö°',N:'Laser',X:'Beam DPS',U:7,bm:1},
tes:{$:160,R:95,A:600,D:18,C:'#aaddff',S:0,Y:'‚öõ',N:'Tesla',X:'Chain√ó3',U:10,ch:3},
mor:{$:200,R:160,A:2200,D:50,C:'#ff6600',S:70,Y:'‚óà',N:'Mortar',X:'Big splash',U:14},
vor:{$:180,R:90,A:2500,D:5,C:'#aa44ff',S:0,Y:'‚ü≥',N:'Vortex',X:'Knockback!',U:18,kb:3},
pul:{$:250,R:80,A:3000,D:15,C:'#ff44ff',S:0,Y:'‚óâ',N:'Pulse',X:'Hits all',U:22,ao:1},
rai:{$:300,R:250,A:3500,D:200,C:'#ffffff',S:0,Y:'‚üê',N:'Rail',X:'Extreme dmg',U:26},
fla:{$:220,R:70,A:100,D:1,C:'#ff8800',S:40,Y:'üî•',N:'Flame',X:'Short cone',U:32,bm:1},
cry:{$:350,R:120,A:4000,D:10,C:'#88ddff',S:80,Y:'‚ùÜ',N:'Cryo',X:'Freeze+splash',U:40,sl:1},
pla:{$:400,R:130,A:1800,D:120,C:'#ff88ff',S:0,Y:'‚¨°',N:'Plasma',X:'Pierce shields',U:55,pc:1},
ann:{$:500,R:180,A:5000,D:500,C:'#ffff00',S:100,Y:'‚ú∂',N:'Annihil',X:'Ultimate',U:75}};
// 5 upgrades per tower: c=cost n=name d=dmg√ó r=rate√ó g=range√ó s=splash√ó
const UG={};
// Generate 5 tiers algorithmically for efficiency
TK.forEach(k=>{const t=TD[k];const b=t.$;UG[k]=[];
for(let i=0;i<5;i++){const m=1+i;const c=Math.round(b*(1+i*1.2)*(1+i*.3));
UG[k].push({c,n:'Lv'+(i+2),d:1+m*.4,r:Math.max(.25,1-m*.12),g:1+m*.04,s:t.S?1+m*.2:0})}});
// Name overrides for flavor
const UN={gun:['Rapid','Burst','Gatling','Minigun','Decimator'],can:['Heavy','Cluster','Artillery','Howitzer','Devastator'],fro:['Chill','Freeze','Blizzard','Permafrost','Abs Zero'],min:['Silver','Gold','Platinum','Diamond','Quantum'],sni:['Marksman','Sharpshot','Deadeye','Railgun','Godshot'],poi:['Toxin','Venom','Plague','Pandemic','Extinction'],las:['Focus','Beam','Ray','Death Ray','Disintegrate'],tes:['Arc','Surge','Storm','Tempest','Thunder God'],mor:['Incendiary','Napalm','Carpet','Siege','Apocalypse'],vor:['Gust','Cyclone','Typhoon','Maelstrom','Singularity'],pul:['Wave','Shock','Blast','Nova','Supernova'],rai:['Charged','Gauss','Coilgun','MagAccel','God Cannon'],fla:['Scorch','Inferno','Hellfire','Firestorm','Solar Flare'],cry:['Flash Freeze','Ice Storm','Glacier','Ice Age','Entropy Zero'],pla:['Ion Bolt','Plasma Arc','Fusion','Antimatter','Dark Energy'],ann:['Charged','Overload','Crit Mass','Stellar','Big Bang']};
TK.forEach(k=>{if(UN[k])UG[k].forEach((u,i)=>u.n=UN[k][i])});
// Mine upgrades: income multiplier (incM) instead of combat stats
UG.min=[{c:80,n:'Silver',incM:1.6},{c:150,n:'Gold',incM:2.4},{c:280,n:'Platinum',incM:3.5},{c:450,n:'Diamond',incM:5},{c:750,n:'Quantum',incM:8}];
// 15 Enemies
const EN=[
{w:0, h:1,  s:1,  r:10,z:10,c:'#ff4488',n:'Drone',      d:'Standard',t:[],ct:'gun'},
{w:2, h:.5, s:1.8,r:8, z:7, c:'#ffee44',n:'Sprinter',   d:'Fast',t:[],ct:'fro'},
{w:4, h:.25,s:1.3,r:4, z:5, c:'#ff88ff',n:'Swarmling',  d:'Tiny swarm',t:[],ct:'can'},
{w:6, h:3,  s:.55,r:18,z:15,c:'#ff6644',n:'Juggernaut', d:'Armored',t:['armor'],ct:'las'},
{w:9, h:1.2,s:1,  r:12,z:10,c:'#44ffaa',n:'Regenerator',d:'Heals',t:['regen'],ct:'poi'},
{w:12,h:.8, s:1.5,r:14,z:8, c:'#ffaadd',n:'Phase Runner',d:'Speeds up',t:['haste'],ct:'sni'},
{w:16,h:2,  s:.8, r:16,z:12,c:'#66ccff',n:'Shielded',   d:'Energy shield',t:['shield'],ct:'tes'},
{w:20,h:1.4,s:1.1,r:15,z:11,c:'#aaffaa',n:'Splitter',   d:'Spawns 2 on death',t:['split'],ct:'pul'},
{w:26,h:2.5,s:.5, r:25,z:16,c:'#ff2200',n:'Behemoth',   d:'Armor+regen',t:['armor','regen'],ct:'rai'},
{w:30,h:1.5,s:1.6,r:20,z:9, c:'#ffff66',n:'Phantom',    d:'Shield+haste',t:['shield','haste'],ct:'vor'},
{w:36,h:3.5,s:.7, r:30,z:14,c:'#ff4400',n:'Titan',      d:'Armor+shield',t:['armor','shield'],ct:'pla'},
{w:44,h:1,  s:2,  r:18,z:6, c:'#ff66ff',n:'Wraith',     d:'Blazing fast',t:['haste'],ct:'tes'},
{w:55,h:5,  s:.6, r:35,z:17,c:'#8800ff',n:'Colossus',   d:'Regen+shield',t:['regen','shield'],ct:'ann'},
{w:70,h:2,  s:1.4,r:22,z:10,c:'#00ffff',n:'Glitch',     d:'Haste+shield',t:['haste','shield'],ct:'cry'},
{w:85,h:8,  s:.65,r:50,z:19,c:'#ff00ff',n:'Overlord',   d:'All traits',t:['armor','regen','shield'],ct:'ann'}];

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let MAP,PATH,gold,lives,wave,score,selT,selP,tws,ens,pjs,pts,wA,spQ,spTm,dead,hov,bst,dif;
let sandbox=false,paused=false,spd=1,autoS=false,started=false,sM=0,sD=1,dTgt='first';
const Di=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);

function fTgt(tw){const ir=[];for(const e of ens)if(Di(tw,e)<=tw.rng)ir.push(e);if(!ir.length)return null;const m=tw.tgt;
if(m==='last')return ir.reduce((a,b)=>b.pI<a.pI?b:a);if(m==='strong')return ir.reduce((a,b)=>b.hp>a.hp?b:a);if(m==='weak')return ir.reduce((a,b)=>b.hp<a.hp?b:a);if(m==='fast')return ir.reduce((a,b)=>b.spd>a.spd?b:a);if(m==='close')return ir.reduce((a,b)=>Di(tw,b)<Di(tw,a)?b:a);return ir.reduce((a,b)=>b.pI>a.pI?b:a)}
function spk(x,y,c,n){for(let i=0;i<n;i++){const a=Math.random()*P,v=.5+Math.random()*2;pts.push({x,y,vx:Math.cos(a)*v,vy:Math.sin(a)*v,l:20+Math.random()*20,c,sz:1+Math.random()*2})}}
function bPath(g){const p=[],v=new Set(),ds=[[1,0],[0,1],[-1,0],[0,-1]];let sx,sy;for(let r=0;r<NR;r++)for(let c=0;c<NC;c++)if(g[r][c]===2){sx=c;sy=r}let x=sx,y=sy;p.push({x,y});v.add(x+','+y);for(;;){const d=ds.find(([a,b])=>{const nx=x+a,ny=y+b;return nx>=0&&nx<NC&&ny>=0&&ny<NR&&!v.has(nx+','+ny)&&g[ny][nx]>=1});if(!d)break;x+=d[0];y+=d[1];v.add(x+','+y);p.push({x,y})}return p}
let tB,tX;
function bake(){tB=new OffscreenCanvas(800,560);tX=tB.getContext('2d');for(let r=0;r<NR;r++)for(let c=0;c<NC;c++){const v=MAP[r][c],x=c*T,y=r*T;tX.fillStyle=v===0?'#0d1118':v===2?'#0a2216':v===3?'#220a0a':'#14142a';tX.fillRect(x,y,T,T);tX.strokeStyle=v===0?'#131a22':'#1c1c38';tX.lineWidth=.5;tX.strokeRect(x+.5,y+.5,T-1,T-1)}tX.strokeStyle='#00ffd00c';tX.lineWidth=16;tX.lineCap='round';tX.lineJoin='round';tX.beginPath();for(const p of PATH)tX.lineTo(p.x*T+T/2,p.y*T+T/2);tX.stroke();tX.strokeStyle='#00ffd006';tX.lineWidth=28;tX.stroke();tX.strokeStyle='#00ffd00a';tX.lineWidth=2;tX.beginPath();for(const p of PATH)tX.lineTo(p.x*T+T/2,p.y*T+T/2);tX.stroke();tX.font='bold 9px Orbitron';tX.textAlign='center';tX.fillStyle='#00ffd0';tX.fillText('‚ñ∂ START',PATH[0].x*T+T/2,PATH[0].y*T+T/2+3);tX.fillStyle='#ff3355';const e=PATH[PATH.length-1];tX.fillText('‚ñ† END',e.x*T+T/2,e.y*T+T/2+3)}

// ‚ïê‚ïê‚ïê UI BUILD ‚ïê‚ïê‚ïê
function bSetup(){const mr=Q('MR');mr.innerHTML='';MAPS.forEach((m,i)=>{const c=document.createElement('div');c.className='MC'+(i===sM?' on':'');const mc=document.createElement('canvas');mc.width=100;mc.height=70;const x=mc.getContext('2d');for(let r=0;r<NR;r++)for(let cl=0;cl<NC;cl++){x.fillStyle=m.g[r][cl]===0?'#0d1118':m.g[r][cl]===2?'#0a2216':m.g[r][cl]===3?'#220a0a':'#14142a';x.fillRect(cl*5,r*5,5,5)}c.appendChild(mc);c.innerHTML+=`<b>${m.n}</b><i>${m.d}</i>`;c.onclick=()=>{sM=i;mr.querySelectorAll('.MC').forEach((e,j)=>e.classList.toggle('on',j===i))};mr.appendChild(c)});
const dr=Q('DR');dr.innerHTML='';DIFFS.forEach((d,i)=>{const c=document.createElement('div');c.className='DC'+(i===sD?' on':'');c.innerHTML=`<b>${d.n}</b><i>${d.g}g¬∑${d.l}‚ô•${d.h>1?' ¬∑'+d.h+'√óHP':''}</i>`;c.onclick=()=>{sD=i;dr.querySelectorAll('.DC').forEach((e,j)=>e.classList.toggle('on',j===i))};dr.appendChild(c)})}
function bTowers(){const el=Q('TL');el.innerHTML='';TK.forEach(k=>{const t=TD[k];const c=document.createElement('div');c.className='TW';c.dataset.k=k;c.innerHTML=`<div class="TI"><div class="TC" style="background:${t.C};color:#000">${t.Y}</div><div><div class="TN" style="color:${t.C}">${t.N}</div><div class="TD2">${t.X}</div><div class="TP">‚¨°${t.$}</div></div></div><div class="LB">üîí Wv${t.U+1}</div>`;c.onclick=()=>pick(k);el.appendChild(c)});
const o=Q('do');o.innerHTML='';TGS.forEach(t=>{const b=document.createElement('div');b.className=t===dTgt?'on':'';b.textContent=TGL[t];b.onclick=()=>{dTgt=t;o.querySelectorAll('div').forEach((e,i)=>e.classList.toggle('on',TGS[i]===t))};o.appendChild(b)})}
function pick(k){if(!sandbox&&TD[k].U>wave)return;selT=k;closeU();document.querySelectorAll('.TW').forEach(c=>c.classList.toggle('sel',(sandbox||wave>=TD[c.dataset.k].U)&&c.dataset.k===k))}

// ‚ïê‚ïê‚ïê UPGRADE POPUP ‚ïê‚ïê‚ïê
function showU(tw){
  selP=tw;const t=TD[tw.tp],lv=tw.lv;
  const isMine=!!t.inc;
  const dps=isMine?0:(tw.dm/(tw.rt/1000));
  Q('un').innerHTML=`<span style="color:${t.C}">${t.Y} ${t.N}</span> <span style="color:#444">Lv${lv+1}</span>`;
  let h;
  if(isMine){const inc=Math.round(t.incAmt*(tw.incM||1));h=`<div class="UR">Income <b style="color:var(--g)">‚¨°${inc}/wave</b></div><div class="UR">Invested <b>‚¨°${tw.inv}</b></div><hr class="UD"><div id="ua"></div>`}
  else{h=`<div class="UR">DMG <b>${(tw.dm*10|0)/10}</b> ¬∑ SPD <b>${tw.rt}ms</b></div><div class="UR">RNG <b>${tw.rng|0}</b> ¬∑ DPS <b style="color:var(--a)">${(dps*10|0)/10}</b></div><div class="UR">Kills <b style="color:#0e8">${tw.kills}</b>${t.kb?' ¬∑ KB <b style="color:#a4f">'+t.kb+'</b>':''}</div><hr class="UD"><div class="TR"><span class="TL">Target</span><span id="to"></span></div><div id="ua"></div>`}
  Q('ub').innerHTML=h;
  if(!isMine){const to=Q('to');TGS.forEach(t2=>{const b=document.createElement('span');b.className='TB'+(tw.tgt===t2?' on':'');b.textContent=TGL[t2];b.onclick=()=>{tw.tgt=t2;to.querySelectorAll('.TB').forEach((e,i)=>e.classList.toggle('on',TGS[i]===t2))};to.appendChild(b)})}
  const ua=Q('ua');
  if(lv<5){const u=UG[tw.tp][lv],ok=gold>=u.c||sandbox;const b=document.createElement('button');b.className='UB'+(ok?'':' no');
    if(isMine){b.innerHTML=`<span>‚¨Ü ${u.n} (‚¨°${Math.round(t.incAmt*u.incM)}/wv)</span><span style="color:var(--g)">‚¨°${u.c}</span>`}
    else{b.innerHTML=`<span>‚¨Ü ${u.n}</span><span style="color:var(--g)">‚¨°${u.c}</span>`}
    b.onclick=()=>{if(!sandbox&&gold<u.c)return;if(!sandbox)gold-=u.c;tw.lv++;
      if(isMine){tw.incM=u.incM}else{tw.dm=t.D*u.d*skE('dmg');tw.rt=Math.max(30,t.A*u.r*skE('spd'))|0;tw.rng=t.R*u.g*skE('rng');if(u.s&&tw.spl)tw.spl=t.S*u.s}
      tw.inv+=u.c;ui();showU(tw)};ua.appendChild(b)}
  else ua.innerHTML='<div style="text-align:center;color:var(--a);font-size:9px;padding:3px">‚òÖ MAX ‚òÖ</div>';
  const sv=tw.inv*(sandbox?1:skE('sell'))|0;const sellBtn=document.createElement('button');sellBtn.className='US';sellBtn.textContent=`Sell ‚¨°${sv}`;
  sellBtn.onclick=()=>{if(settings.confirmSell){pendingSell={tw,sv};const cf=Q('confirm');cf.classList.add('show');const pop=Q('U');cf.style.left=pop.style.left;cf.style.top=(parseInt(pop.style.top)+pop.offsetHeight+4)+'px'}else{doSell(tw,sv)}};
  ua.appendChild(sellBtn);
  const pop=Q('U');pop.classList.add('show');const rect=cv.getBoundingClientRect(),sx=cv.width/rect.width;let px=tw.x/sx-118,py=tw.y/sx-pop.offsetHeight-18;if(py<4)py=tw.y/sx+22;px=Math.max(4,Math.min(px,rect.width-240));py=Math.max(4,Math.min(py,rect.height-pop.offsetHeight-4));pop.style.left=px+'px';pop.style.top=py+'px';
}

function ui(){
  Q('vg').textContent=sandbox?'‚àû':gold;Q('vl').textContent=sandbox?'‚àû':lives;Q('vw').textContent=wave;Q('vs').textContent=score;
  Q('wb').disabled=wA;Q('wb').textContent='Wave '+(wave+1);
  const pool=[];for(let i=0;i<EN.length;i++)if(wave+1>EN[i].w||i===0)pool.push(i);
  Q('wp').textContent='Next: '+[...new Set(pool.map(i=>EN[i].n))].slice(0,4).join(', ');
  document.querySelectorAll('.TW').forEach(c=>{const k=c.dataset.k,t=TD[k],ul=sandbox||wave>=t.U;c.classList.toggle('lk',!ul);c.classList.toggle('brk',ul&&!sandbox&&gold<t.$);c.classList.toggle('sel',ul&&k===selT)});
  if(selP&&tws.includes(selP))showU(selP);
  rBst();
}

function init(){
  dif=DIFFS[sD];gold=(sandbox?99999:dif.g+skE('gold'));lives=sandbox?999:dif.l+skE('lives');
  wave=0;score=0;selT='gun';closeU();tws=[];ens=[];pjs=[];pts=[];wA=false;spQ=[];dead=false;hov=null;spTm=0;gt=0;
  paused=false;spd=settings.defSpeed||1;autoS=settings.defAuto||false;
  bst=EN.map(()=>({s:0,sp:0,kl:0,lk:0,mh:0}));
  Q('GO').classList.remove('show');Q('pb').textContent='‚è∏';Q('pb').classList.remove('on');
  Q('xb').textContent=spd+'√ó';Q('xb').classList.toggle('on',spd>1);
  Q('ab').classList.toggle('on',autoS);
  Q('wa').textContent='\u00a0';Q('wa').className='WA hd';
  bTowers();pick('gun');ui();
}

// ‚ïê‚ïê‚ïê EVENTS ‚ïê‚ïê‚ïê
function launch(sb){sandbox=sb;Q('S').classList.add('off');MAP=MAPS[sM].g;PATH=bPath(MAP);bake();init();started=true;rsz()}
Q('go').onclick=()=>launch(false);Q('sb').onclick=()=>launch(true);
Q('wb').onclick=startW;
Q('ab').onclick=()=>{autoS=!autoS;Q('ab').classList.toggle('on',autoS)};
Q('pb').onclick=()=>{paused=!paused;Q('pb').textContent=paused?'‚ñ∂':'‚è∏';Q('pb').classList.toggle('on',paused)};
Q('xb').onclick=()=>{spd=spd===1?2:spd===2?3:1;Q('xb').textContent=spd+'√ó';Q('xb').classList.toggle('on',spd>1)};
function toMenu(){Q('S').classList.remove('off');Q('GO').classList.remove('show');started=false;bSetup()}
Q('nb').onclick=toMenu;Q('gb').onclick=toMenu;Q('ux').onclick=closeU;

function rsz(){if(!started)return;const w=Q('CW'),s=Math.min(w.clientWidth/800,w.clientHeight/560);cv.style.width=(800*s)+'px';cv.style.height=(560*s)+'px'}
window.onresize=rsz;
// Resize handle
let resizing=false;
Q('RZ').onmousedown=e=>{resizing=true;e.preventDefault()};
document.onmousemove=e=>{if(!resizing)return;const gm=Q('G'),si=Q('R');const w=gm.getBoundingClientRect().right-e.clientX;si.style.width=Math.max(140,Math.min(300,w))+'px';rsz()};
document.onmouseup=()=>resizing=false;

cv.onclick=e=>{if(dead||!started)return;const r=cv.getBoundingClientRect(),sx=cv.width/r.width;const mx=(e.clientX-r.left)*sx,my=(e.clientY-r.top)*sx;const c=mx/T|0,rw=my/T|0;if(c<0||c>=NC||rw<0||rw>=NR)return;const ex=tws.find(t=>t.co===c&&t.ro===rw);if(ex){showU(ex);return}closeU();if(MAP[rw][c]!==0)return;const t=TD[selT];if(!sandbox&&(gold<t.$||wave<t.U))return;if(!sandbox)gold-=t.$;tws.push({co:c,ro:rw,x:c*T+T/2,y:rw*T+T/2,tp:selT,dm:t.D*skE('dmg'),rng:t.R*skE('rng'),rt:Math.max(30,t.A*skE('spd'))|0,spl:t.S||0,cc:t.C,lf:0,an:0,lv:0,inv:t.$,bt:null,ct:null,ctm:0,tgt:dTgt,kills:0,incM:1});ui()};
cv.onmousemove=e=>{const r=cv.getBoundingClientRect(),sx=cv.width/r.width;hov={c:((e.clientX-r.left)*sx/T)|0,r:((e.clientY-r.top)*sx/T)|0}};
cv.onmouseleave=()=>hov=null;
document.onkeydown=e=>{if(!started)return;if(e.key===' '||e.key==='Enter'){e.preventDefault();startW()}else if(e.key==='p'||e.key==='P')Q('pb').click();else if(e.key==='s'||e.key==='S')Q('xb').click();else if(e.key==='Escape')closeU();else{const n=e.key==='0'?10:parseInt(e.key);if(n>=1&&n<=TK.length)pick(TK[n-1])}};

// ‚ïê‚ïê‚ïê WAVES ‚ïê‚ïê‚ïê
function startW(){
  if(wA||dead||!started)return;wave++;wA=true;closeU();
  const hp=20*Math.pow(1.11,wave)*(1+wave*.015)*dif.h;
  const sp=1+Math.min(wave*.03,1.1)+Math.max(0,(wave-35)*.006);
  const cnt=Math.min(6+wave*1.5,35)+Math.max(0,Math.floor((wave-25)*.6));
  const rS=Math.max(.3,1-wave*.012)*dif.r;
  const boss=wave%10===0;
  const pool=[];for(let i=0;i<EN.length;i++)if(wave>EN[i].w||i===0)pool.push(i);
  spQ=[];const nt=EN.filter(e=>e.w===wave),al=Q('wa');
  if(boss){al.textContent='‚ö† BOSS WAVE';al.className='WA bo'}
  else if(nt.length){al.textContent='NEW: '+nt.map(e=>e.n).join(', ');al.className='WA nw'}
  else{al.textContent='\u00a0';al.className='WA hd'}
  if(boss){const bi=pool[pool.length-1],bt=EN[bi],bc=Math.min(1+Math.floor(wave/15),8);for(let i=0;i<bc;i++){const eh=hp*bt.h*2*(1+wave*.02);bst[bi].s=1;bst[bi].sp++;bst[bi].mh=Math.max(bst[bi].mh,eh);spQ.push(mkE(bi,eh,sp*.7,Math.ceil(bt.r*rS*2),hp))}}
  const nc=boss?Math.floor(cnt*.4):cnt;
  const hMax=Math.floor(nc*(wave>=30?.6:.2));let hCnt=0;
  for(let i=0;i<nc;i++){let ti=pool[0];if(pool.length>1){const w=pool.map(idx=>{const a=wave-EN[idx].w;const base=a<4?.4:a<8?.25:.12;return idx>=7?base*.25:idx>=5?base*.5:base});w[0]=.08;const s=w.reduce((a,b)=>a+b);let r=Math.random()*s,c=0;for(let j=0;j<pool.length;j++){c+=w[j];if(r<c){ti=pool[j];break}}}
  const t=EN[ti],eh=hp*t.h;
  if(eh>900&&hCnt>=hMax){ti=0;const t2=EN[0],eh2=hp*t2.h;bst[0].s=1;bst[0].sp++;bst[0].mh=Math.max(bst[0].mh,eh2);spQ.push(mkE(0,eh2,sp*t2.s,Math.ceil(t2.r*rS),hp));continue}
  if(eh>900)hCnt++;
  bst[ti].s=1;bst[ti].sp++;bst[ti].mh=Math.max(bst[ti].mh,eh);spQ.push(mkE(ti,eh,sp*t.s,Math.ceil(t.r*rS),hp))}
  spTm=0;ui();
}
function mkE(ti,hp,sp,rw,bH){const t=EN[ti],H=x=>t.t.includes(x);return{hp,mh:hp,spd:sp,rw,pI:0,x:PATH[0].x*T+T/2,y:PATH[0].y*T+T/2,st:0,dt:0,dd:0,sz:t.z,col:t.c,ti,ar:H('armor')?Math.max(2,bH*.035):0,rg:H('regen')?hp*.007:0,sh:H('shield')?hp*.3:0,sm:H('shield')?hp*.3:0,hs:H('haste')?1:0,sp2:H('split')?1:0,dT:0}}
function dmg(e,raw,pierce){let d=raw;if(Math.random()<skE('crit'))d*=2;if(e.ar&&!pierce)d=Math.max(1,d-e.ar);if(e.sh>0&&!pierce){const a=Math.min(e.sh,d);e.sh-=a;d-=a}e.hp-=d}

// ‚ïê‚ïê‚ïê KNOCKBACK ‚ïê‚ïê‚ïê
function knockback(e,tiles){
  let newPI=Math.max(0,e.pI-tiles);e.pI=newPI;
  const wp=PATH[newPI];e.x=wp.x*T+T/2;e.y=wp.y*T+T/2;e.dT=Math.max(0,e.dT-tiles*T);
}

// ‚ïê‚ïê‚ïê GAME LOOP ‚ïê‚ïê‚ïê
let lt=0,gt=0;
function loop(t){const rd=Math.min(t-lt,33);lt=t;if(started&&!dead&&!paused){const dt=rd*spd;gt+=dt;upd(dt,gt)}if(started)drw(gt);requestAnimationFrame(loop)}

function upd(dt,t){
  if(spQ.length){spTm-=dt;if(spTm<=0){ens.push(spQ.shift());spTm=Math.max(100,380-wave*5)}}
  for(let i=ens.length-1;i>=0;i--){const e=ens[i];if(e.st>0)e.st-=dt;if(e.dt>0){e.dt-=dt;e.hp-=e.dd*dt/1000}if(e.rg&&e.hp<e.mh)e.hp=Math.min(e.mh,e.hp+e.rg*dt/1000);
  let sm=e.st>0?.35:1;if(e.hs)sm*=1+e.dT*.0003;const sp=e.spd*sm,wp=PATH[e.pI+1];
  if(!wp){if(!sandbox)lives--;bst[e.ti].lk++;ens.splice(i,1);if(!sandbox&&lives<=0){dead=true;
    const earned=Math.floor(wave/5);cores+=earned;skSave();
    Q('gt').textContent=`Wave ${wave} ¬∑ Score: ${score}`;Q('gc').textContent=earned?'+ '+earned+' Cores earned!':'';Q('GO').classList.add('show')}ui();continue}
  const tx=wp.x*T+T/2,ty=wp.y*T+T/2,dx=tx-e.x,dy=ty-e.y,d=Math.hypot(dx,dy),mv=sp*dt/16;
  if(d<mv){e.x=tx;e.y=ty;e.pI++;e.dT+=d}else{const m=mv/d;e.x+=dx*m;e.y+=dy*m;e.dT+=mv}}

  for(const tw of tws){const td=TD[tw.tp];
    if(td.inc)continue; // Mine: no combat
    if(td.bm){const tg=fTgt(tw);tw.bt=tg;if(tg&&t-tw.lf>=tw.rt){tw.lf=t;tw.an=Math.atan2(tg.y-tw.y,tg.x-tw.x);dmg(tg,tw.dm,td.pc);if(Math.random()<.12)spk(tg.x,tg.y,tw.cc,1)}continue}
    if(td.ao){if(t-tw.lf<tw.rt)continue;let hit=0;for(const e of ens)if(Di(tw,e)<=tw.rng){dmg(e,tw.dm);spk(e.x,e.y,tw.cc,2);hit=1}if(hit){tw.lf=t;spk(tw.x,tw.y,tw.cc+'88',6)}continue}
    if(td.ch){if(t-tw.lf<tw.rt)continue;const tg=fTgt(tw);if(tg){tw.lf=t;tw.an=Math.atan2(tg.y-tw.y,tg.x-tw.x);const ts=[tg];let cur=tg;for(let c=1;c<td.ch;c++){let b=null,bd=120;for(const e of ens)if(!ts.includes(e)&&Di(cur,e)<bd){bd=Di(cur,e);b=e}if(b){ts.push(b);cur=b}else break}for(const e of ts){dmg(e,tw.dm);spk(e.x,e.y,tw.cc,3)}tw.ct=ts;tw.ctm=t}continue}
    if(td.kb){if(t-tw.lf<tw.rt)continue;const tg=fTgt(tw);if(tg){tw.lf=t;tw.an=Math.atan2(tg.y-tw.y,tg.x-tw.x);dmg(tg,tw.dm);knockback(tg,td.kb);spk(tg.x,tg.y,tw.cc,8);tw.kills++}continue}
    if(t-tw.lf<tw.rt)continue;const tg=fTgt(tw);if(tg){tw.lf=t;tw.an=Math.atan2(tg.y-tw.y,tg.x-tw.x);pjs.push({x:tw.x,y:tw.y,tg,dm:tw.dm,sp:tw.spl,sl:td.sl,dt:td.dt,pc:td.pc,c:tw.cc,ow:tw})}}

  for(let i=pjs.length-1;i>=0;i--){const p=pjs[i];if(!ens.includes(p.tg)){pjs.splice(i,1);continue}const dx=p.tg.x-p.x,dy=p.tg.y-p.y,d=Math.hypot(dx,dy);
  if(d<8){if(p.sp>0){for(const e of ens)if(Di(p,e)<=p.sp){if(p.dt){e.dt=3000;e.dd=Math.max(e.dd,p.dm)}else dmg(e,p.dm,p.pc);spk(e.x,e.y,p.c,2)}spk(p.x,p.y,p.c,6)}
  else{dmg(p.tg,p.dm,p.pc);if(p.sl)p.tg.st=1500;if(p.dt){p.tg.dt=3000;p.tg.dd=Math.max(p.tg.dd,p.dm)}spk(p.tg.x,p.tg.y,p.c,4)}if(p.ow)p.ow.kills++;pjs.splice(i,1)}
  else{const m=15*dt/(16*d);p.x+=dx*m;p.y+=dy*m}}

  for(let i=ens.length-1;i>=0;i--)if(ens[i].hp<=0){const e=ens[i];const rw=Math.ceil(e.rw*skE('inc'));gold+=sandbox?0:rw;score+=rw*2;bst[e.ti].kl++;
  // Splitter: spawn 2 mini enemies
  if(e.sp2&&e.mh>20){const mhp=e.mh*.3;for(let j=0;j<2;j++){const c={...e,hp:mhp,mh:mhp,sz:Math.max(3,e.sz-3),sp2:0,rw:Math.ceil(e.rw*.3),spd:e.spd*1.3};c.x+=(-1+j*2)*8;ens.push(c)}}
  spk(e.x,e.y,'#fff',10);ens.splice(i,1);ui()}
  for(let i=pts.length-1;i>=0;i--){pts[i].x+=pts[i].vx;pts[i].y+=pts[i].vy;if(--pts[i].l<=0)pts.splice(i,1)}
  if(wA&&!ens.length&&!spQ.length){wA=false;
    // Wave completion bonus
    let bonus=20+wave*4;
    // Mine income
    for(const tw of tws)if(TD[tw.tp].inc){bonus+=Math.round(TD[tw.tp].incAmt*(tw.incM||1))}
    if(!sandbox)gold+=bonus;
    ui();if(autoS&&!dead)setTimeout(startW,400)}
}

// ‚ïê‚ïê‚ïê DRAW ‚ïê‚ïê‚ïê
function drw(t){
  cx.drawImage(tB,0,0);
  if(paused){cx.fillStyle='#06060ccc';cx.fillRect(0,0,800,560);cx.fillStyle='#fff';cx.font='bold 22px Orbitron';cx.textAlign='center';cx.textBaseline='middle';cx.fillText('PAUSED',400,270);cx.fillStyle='#444';cx.font='11px JetBrains Mono';cx.fillText('P to resume',400,296);return}
  if(hov&&!dead&&!selP){const{c,r}=hov;if(c>=0&&c<NC&&r>=0&&r<NR&&MAP[r][c]===0&&!tws.some(t=>t.co===c&&t.ro===r)){const td=TD[selT],px=c*T+T/2,py=r*T+T/2,ok=sandbox||gold>=td.$&&wave>=td.U;const g=cx.createRadialGradient(px,py,0,px,py,td.R);g.addColorStop(0,ok?'#00ffd008':'#ff335508');g.addColorStop(1,'transparent');cx.fillStyle=g;cx.beginPath();cx.arc(px,py,td.R,0,P);cx.fill();cx.strokeStyle=ok?'#00ffd030':'#ff335530';cx.lineWidth=1;cx.stroke();cx.globalAlpha=.35;cx.fillStyle=td.C;cx.beginPath();cx.arc(px,py,12,0,P);cx.fill();cx.globalAlpha=1}}
  if(selP){const g=cx.createRadialGradient(selP.x,selP.y,0,selP.x,selP.y,selP.rng);g.addColorStop(0,selP.cc+'0c');g.addColorStop(1,'transparent');cx.fillStyle=g;cx.beginPath();cx.arc(selP.x,selP.y,selP.rng,0,P);cx.fill();cx.strokeStyle=selP.cc+'44';cx.lineWidth=1.5;cx.stroke()}
  for(const tw of tws){const lv=tw.lv,sel=tw===selP,td=TD[tw.tp];cx.fillStyle='#0005';cx.beginPath();cx.arc(tw.x+1,tw.y+1,15,0,P);cx.fill();cx.fillStyle=sel?tw.cc+'33':tw.cc+'18';cx.beginPath();cx.arc(tw.x,tw.y,17,0,P);cx.fill();const bg=cx.createRadialGradient(tw.x-3,tw.y-3,0,tw.x,tw.y,14+lv);bg.addColorStop(0,tw.cc);bg.addColorStop(1,tw.cc+'88');cx.fillStyle=bg;cx.beginPath();cx.arc(tw.x,tw.y,12+lv,0,P);cx.fill();
  if(!td.dt&&!td.ao&&!td.kb&&!td.inc){cx.strokeStyle=tw.cc;cx.lineWidth=3+lv*.4;cx.lineCap='round';cx.beginPath();cx.moveTo(tw.x,tw.y);cx.lineTo(tw.x+Math.cos(tw.an)*(18+lv*2),tw.y+Math.sin(tw.an)*(18+lv*2));cx.stroke()}
  if(td.inc){cx.fillStyle='#ffcc0088';cx.font='bold '+(10+lv*2)+'px Orbitron';cx.textAlign='center';cx.textBaseline='middle';cx.fillText('‚¨°',tw.x,tw.y+1)}
  if(td.ao){const a=t-tw.lf;if(a<500){cx.globalAlpha=(1-a/500)*.5;cx.strokeStyle=tw.cc;cx.lineWidth=2;cx.beginPath();cx.arc(tw.x,tw.y,tw.rng*(a/500),0,P);cx.stroke();cx.globalAlpha=1}}
  if(td.kb){cx.strokeStyle=tw.cc+'66';cx.lineWidth=1;cx.setLineDash([3,3]);cx.beginPath();cx.arc(tw.x,tw.y,tw.rng,0,P);cx.stroke();cx.setLineDash([])}
  cx.fillStyle='#000';cx.beginPath();cx.arc(tw.x,tw.y,3.5,0,P);cx.fill();
  for(let l=0;l<lv;l++){cx.fillStyle='#ffc830';cx.beginPath();cx.arc(tw.x-5+l*5,tw.y+17,1.5,0,P);cx.fill()}
  if(!td.inc){cx.fillStyle=tw.cc;cx.font='bold 6px Orbitron';cx.textAlign='center';cx.textBaseline='middle';cx.fillText(TGI[tw.tgt],tw.x+14,tw.y-14)}
  if(td.bm&&tw.bt&&ens.includes(tw.bt)){cx.globalAlpha=.6+Math.sin(t*.03)*.4;cx.strokeStyle=tw.cc;cx.lineWidth=2+Math.sin(t*.02);cx.beginPath();cx.moveTo(tw.x,tw.y);cx.lineTo(tw.bt.x,tw.bt.y);cx.stroke();cx.strokeStyle=tw.cc+'33';cx.lineWidth=8;cx.stroke();cx.globalAlpha=1}
  if(td.ch&&tw.ct&&t-tw.ctm<300){cx.globalAlpha=(1-(t-tw.ctm)/300)*.8;cx.strokeStyle=tw.cc;cx.lineWidth=2;cx.beginPath();cx.moveTo(tw.x,tw.y);for(const e of tw.ct)if(ens.includes(e))cx.lineTo(e.x,e.y);cx.stroke();cx.globalAlpha=1}}
  for(const e of ens){cx.fillStyle='#0005';cx.beginPath();cx.arc(e.x+2,e.y+2,e.sz,0,P);cx.fill();const bc=e.dt>0?'#88cc00':e.st>0?'#4488ff':e.col;const eg=cx.createRadialGradient(e.x-e.sz*.3,e.y-e.sz*.3,0,e.x,e.y,e.sz);eg.addColorStop(0,bc);eg.addColorStop(1,bc+'88');cx.fillStyle=eg;cx.beginPath();cx.arc(e.x,e.y,e.sz,0,P);cx.fill();cx.strokeStyle=bc+'55';cx.lineWidth=1.5;cx.stroke();if(e.sm>0&&e.sh>0){cx.strokeStyle='#66ccff88';cx.lineWidth=2;cx.beginPath();cx.arc(e.x,e.y,e.sz+3,-.5*Math.PI,-.5*Math.PI+P*(e.sh/e.sm));cx.stroke()}if(e.ar>0){cx.fillStyle='#999';cx.beginPath();cx.arc(e.x,e.y+e.sz+5,1.5,0,P);cx.fill()}const bw=Math.max(e.sz*2.5,16),hr=Math.max(0,e.hp/e.mh);cx.fillStyle='#0008';cx.fillRect(e.x-bw/2,e.y-e.sz-9,bw,4);cx.fillStyle=hr>.5?'#00ff88':hr>.25?'#ffaa00':'#ff3344';cx.fillRect(e.x-bw/2,e.y-e.sz-9,bw*hr,4)}
  for(const p of pjs){const r=p.sp>0?4:2.5;cx.fillStyle=p.c;cx.beginPath();cx.arc(p.x,p.y,r,0,P);cx.fill();cx.fillStyle=p.c+'66';cx.beginPath();cx.arc(p.x,p.y,r+2,0,P);cx.fill()}
  for(const p of pts){cx.globalAlpha=p.l/40;cx.fillStyle=p.c;cx.beginPath();cx.arc(p.x,p.y,p.sz*(p.l/40),0,P);cx.fill()}
  cx.globalAlpha=1;
}

// ‚ïê‚ïê‚ïê BESTIARY ‚ïê‚ïê‚ïê
function rBst(){
  if(!bst)return;const el=Q('BL');el.innerHTML='';
  EN.forEach((t,i)=>{const s=bst[i],seen=s.s;const c=document.createElement('div');c.className='BE'+(seen?'':' hd');
  const oc=document.createElement('canvas');oc.width=18;oc.height=18;const o=oc.getContext('2d'),r=Math.min(7,Math.max(3,t.z*.45));o.fillStyle=seen?t.c:'#333';o.beginPath();o.arc(9,9,r,0,P);o.fill();
  if(!seen){o.fillStyle='#444';o.font='7px Orbitron';o.textAlign='center';o.textBaseline='middle';o.fillText('?',9,9)}
  const kr=s.sp?((s.kl/s.sp)*100|0)+'%':'‚Äî',lr=s.sp?((s.lk/s.sp)*100|0)+'%':'‚Äî';
  const ct=TD[t.ct];
  c.innerHTML=`<div class="BH"><div class="BO"></div><div><div class="BN" style="color:${seen?t.c:'#333'}">${seen?t.n:'???'}</div><div class="BD">${seen?t.d:'Wv'+(t.w+1)}</div></div></div>${seen?`<div class="BG"><div><span class="k">KL</span><br><span class="v" style="color:#0e8">${s.kl} ${kr}</span></div><div><span class="k">LK</span><br><span class="v" style="color:var(--r)">${s.lk} ${lr}</span></div></div><div class="BK">‚ä≥ <strong style="color:${ct.C}">${ct.Y} ${ct.N}</strong></div>`:''}`;
  c.querySelector('.BO').appendChild(oc);el.appendChild(c)});
}

// ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê
let settings={confirmSell:true,defDiff:1,defSpeed:1,defAuto:false};
let pendingSell=null;
function loadSettings(){try{const d=JSON.parse(localStorage.getItem('bastion_set'));if(d)settings={...settings,...d}}catch(e){}}
function saveSettings(){try{localStorage.setItem('bastion_set',JSON.stringify(settings))}catch(e){}}
loadSettings();sD=settings.defDiff;
function initSettingsUI(){
  const dd=Q('s-diff');dd.innerHTML='';DIFFS.forEach((d,i)=>{const o=document.createElement('option');o.value=i;o.textContent=d.n;dd.appendChild(o)});dd.value=settings.defDiff;
  Q('s-confirm').checked=settings.confirmSell;
  Q('s-speed').value=settings.defSpeed;
  Q('s-auto').checked=settings.defAuto;
}
Q('seto').onclick=()=>{Q('SET').classList.add('show');initSettingsUI()};
Q('setx').onclick=()=>{
  settings.defDiff=parseInt(Q('s-diff').value);settings.confirmSell=Q('s-confirm').checked;
  settings.defSpeed=parseInt(Q('s-speed').value);settings.defAuto=Q('s-auto').checked;
  sD=settings.defDiff;saveSettings();Q('SET').classList.remove('show');bSetup()};
function doSell(tw,sv){gold+=sv;tws.splice(tws.indexOf(tw),1);closeU();Q('confirm').classList.remove('show');pendingSell=null;ui()}
Q('cf-y').onclick=()=>{if(pendingSell)doSell(pendingSell.tw,pendingSell.sv)};
Q('cf-n').onclick=()=>{Q('confirm').classList.remove('show');pendingSell=null};
function closeU(){selP=null;Q('U').classList.remove('show');Q('confirm').classList.remove('show');pendingSell=null}

bSetup();requestAnimationFrame(loop);
</script></body></html>
